generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  PASSENGER
  DRIVER
  ADMIN
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  REFUNDED
}

enum TransactionType {
  ESCROW_IN
  ESCROW_OUT
  DRIVER_PAYOUT
  REFUND
}

enum RefundStatus {
  PENDING
  COMPLETED
  FAILED
}

model User {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  email    String   @unique
  password String
  role     UserRole @default(PASSENGER)

  trips    Trip[]
  bookings Booking[]
  wallet   Wallet?
}

model Trip {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  driverId String
  driver   User   @relation(fields: [driverId], references: [id])

  origin      String
  destination String
  date        DateTime
  price       Int
  seatsTotal  Int
  seatsLeft   Int

  bookings Booking[]
}

model Booking {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  tripId String
  userId String

  trip Trip @relation(fields: [tripId], references: [id])
  user User @relation(fields: [userId], references: [id])

  seats  Int
  status BookingStatus @default(PENDING)

  paymentIntentId String?

  // 1-to-1 refund relation
  refund Refund?
}

model Wallet {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  balance Int @default(0)

  transactions Transaction[]
}

model Transaction {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  walletId String
  wallet   Wallet @relation(fields: [walletId], references: [id])

  amount Int
  type   TransactionType
}

model Refund {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  // must be unique for a 1-to-1 relation
  bookingId String @unique

  booking Booking @relation(fields: [bookingId], references: [id])

  status RefundStatus @default(PENDING)
}

model Outbox {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  type      String
  payload   Json
  processed Boolean @default(false)
}
