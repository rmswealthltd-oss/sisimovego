(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[81],{5167:function(){},5292:function(){},4e3:function(){},9674:function(t,e,n){Promise.resolve().then(n.bind(n,4162)),Promise.resolve().then(n.bind(n,1987))},4162:function(t,e,n){"use strict";n.r(e),n.d(e,{default:function(){return S}});var r=n(6543),l=n(5729),o=n(6067),i=n(5695),u=n(3593),s=n(6429),a=n(1320),c=n(5167),d=n.n(c);n(5292);let v=d().icon({iconUrl:"/leaflet/marker-icon.png",shadowUrl:"/leaflet/marker-shadow.png",iconAnchor:[12,41]});function f(t){let{coords:e}=t,n=(0,o.Sx)();return(0,l.useEffect)(()=>{if(!n||!e||0===e.length)return;let t=d().latLngBounds(e);n.fitBounds(t.pad(.15))},[e,n]),null}function p(t){let{active:e,position:n}=t,r=(0,o.Sx)();return(0,l.useEffect)(()=>{r&&e&&n&&r.setView(n,r.getZoom(),{animate:!0})},[e,n,r]),null}function g(t){let{center:e=[0,0],zoom:n=13,markers:l=[],fitBounds:o=!1,children:c,height:d="100%",autoFollow:v=!1,followPosition:g=null}=t;return(0,r.jsx)("div",{style:{height:d,width:"100%"},children:(0,r.jsxs)(i.h,{center:e,zoom:n,scrollWheelZoom:!0,style:{height:"100%",width:"100%"},children:[(0,r.jsx)(u.I,{attribution:"\xa9 OpenStreetMap",url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),o&&l.length>0&&(0,r.jsx)(f,{coords:l.map(t=>[t.lat,t.lng])}),v&&g&&(0,r.jsx)(p,{active:v,position:g}),l.map((t,e)=>(0,r.jsx)(s.J,{position:[t.lat,t.lng],children:t.popup&&(0,r.jsx)(a.G,{children:t.popup})},e)),c]})})}function h(t){var e,n,o;let{position:i,driver:u,title:a}=t,c=(0,l.useRef)(null),v=d().divIcon({className:"driver-marker",html:'\n      <div style="display:flex;flex-direction:column;align-items:center">\n        <div style="width:40px;height:40px;border-radius:50%;overflow:hidden;border:2px solid white;box-shadow:0 1px 3px rgba(0,0,0,0.2)">\n          <img src="'.concat(null!==(e=null==u?void 0:u.avatarUrl)&&void 0!==e?e:"/icons/driver.png",'" style="width:40px;height:40px;object-fit:cover" />\n        </div>\n        <div style="background:rgba(0,0,0,0.6);color:white;padding:2px 6px;border-radius:6px;margin-top:6px;font-size:11px">\n          ').concat(null!==(o=null!==(n=null==u?void 0:u.name)&&void 0!==n?n:a)&&void 0!==o?o:"Driver","\n        </div>\n      </div>\n    "),iconSize:[40,58],iconAnchor:[20,58]});return(0,l.useEffect)(()=>{if(!c.current)return;let t=c.current,e=t.getLatLng(),n=d().latLng(i[0],i[1]),r=Math.max(6,Math.round(37.5)),l=0,o=(n.lat-e.lat)/r,u=(n.lng-e.lng)/r,s=()=>{l++;let n=d().latLng(e.lat+o*l,e.lng+u*l);t.setLatLng(n),l<r&&requestAnimationFrame(s)};requestAnimationFrame(s)},[i]),(0,r.jsx)(s.J,{ref:t=>{c.current=t},position:i,icon:v})}d().Marker.prototype.options.icon=v;var m=n(7023),x=n(148);n(2702);var b=n(2702);let w=null;function S(t){var e;let{tripId:n}=t,{driverLocation:o,trip:i}=function(t){let[e,n]=(0,l.useState)(!1),[r,o]=(0,l.useState)(null),[i,u]=(0,l.useState)(null),[s,a]=(0,l.useState)(null),c=(0,l.useRef)(null),d=(0,l.useRef)({}),v=(0,l.useRef)(null);function f(){v.current||(v.current=setTimeout(()=>{v.current=null,function(){let t=d.current;t.loc&&o(t.loc),t.trip&&u(e=>({...e||{},...t.trip})),void 0!==t.status&&a(t.status),d.current={}}()},200))}return(0,l.useEffect)(()=>{if(!t)return;let e=function(){if(w)return w;let t=b.env.NEXT_PUBLIC_API_WS||"http://localhost:3001";return w=(0,m.io)(t,{auth:{token:x.t.get("sisimove_token")}})}();c.current=e;let r=()=>{n(!0),e.emit("subscribe:trip",{tripId:t}),e.emit("get:trip",{tripId:t})},l=()=>{n(!1)},o=t=>{let e=function(t){var e,n,r,l,o,i,u,s,a;if(!t)return null;let c=Number(null!==(r=null!==(n=t.lat)&&void 0!==n?n:t.latitude)&&void 0!==r?r:t.lat_gps),d=Number(null!==(o=null!==(l=t.lng)&&void 0!==l?l:t.longitude)&&void 0!==o?o:t.lng_gps),v=null!==(u=null!==(i=t.ts)&&void 0!==i?i:t.time)&&void 0!==u?u:new Date().toISOString();return Number.isNaN(c)||Number.isNaN(d)?null:{lat:c,lng:d,ts:v,driverId:null!==(a=null!==(s=t.driverId)&&void 0!==s?s:t.driver_id)&&void 0!==a?a:null===(e=t.driver)||void 0===e?void 0:e.id}}(t);e&&(d.current.loc=e,f())},i=t=>{var e,n,r,l,o,i;let u=t?{id:null!==(n=null!==(e=t.id)&&void 0!==e?e:t.tripId)&&void 0!==n?n:t.trip_id,status:null!==(r=t.status)&&void 0!==r?r:t.state,driver:null!==(l=t.driver)&&void 0!==l?l:t.driver_info,route:null!==(i=null!==(o=t.route)&&void 0!==o?o:t.polyline)&&void 0!==i?i:t.path}:null;u&&(d.current.trip=u,f())},u=t=>{var e,n;let r=null!==(n=null!==(e=null==t?void 0:t.status)&&void 0!==e?e:t)&&void 0!==n?n:null;d.current.status=r,f()};return e.on("connect",r),e.on("disconnect",l),e.on("driver:location",o),e.on("trip:update",i),e.on("trip:status",u),()=>{try{e.emit("unsubscribe:trip",{tripId:t})}catch(t){}e.off("connect",r),e.off("disconnect",l),e.off("driver:location",o),e.off("trip:update",i),e.off("trip:status",u),v.current&&(clearTimeout(v.current),v.current=null),c.current=null}},[t]),{connected:e,driverLocation:r,trip:i,status:s,socket:c.current}}(n),u=o?[o.lat,o.lng]:(null==i?void 0:null===(e=i.origin)||void 0===e?void 0:e.lat)?[i.origin.lat,i.origin.lng]:[0,0];return(0,r.jsx)("div",{className:"h-96 rounded overflow-hidden shadow",children:(0,r.jsx)(g,{center:u,zoom:13,autoFollow:!0,followPosition:o?[o.lat,o.lng]:null,children:o&&(0,r.jsx)(h,{position:[o.lat,o.lng]})})})}},148:function(t,e,n){"use strict";n.d(e,{t:function(){return r}});let r={set(t,e){try{"string"==typeof e?localStorage.setItem(t,e):localStorage.setItem(t,JSON.stringify(e))}catch(t){console.error("storage.set error:",t)}},get(t){try{let e=localStorage.getItem(t);if(!e)return null;if(e.startsWith("{")||e.startsWith("[")||"null"===e)return JSON.parse(e);return e}catch(t){return console.error("storage.get error:",t),null}},remove(t){try{localStorage.removeItem(t)}catch(t){console.error("storage.remove error:",t)}}}}},function(t){t.O(0,[371,585,682,744],function(){return t(t.s=9674)}),_N_E=t.O()}]);