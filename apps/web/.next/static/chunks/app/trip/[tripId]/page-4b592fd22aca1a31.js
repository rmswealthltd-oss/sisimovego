(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[659],{5167:function(){},5292:function(){},4e3:function(){},9519:function(e,t,r){Promise.resolve().then(r.bind(r,1637)),Promise.resolve().then(r.bind(r,4162)),Promise.resolve().then(r.bind(r,4580)),Promise.resolve().then(r.bind(r,1987))},1637:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return s}});var n=r(6543),l=r(5729),i=r(187),o=r(615);function s(e){let{serverTrip:t}=e,r=(0,o.useRouter)(),[s,a]=(0,l.useState)(1),[u,c]=(0,l.useState)(!1);async function d(e){if(null==e||e.preventDefault(),t){c(!0);try{var n,l;let e=await i.V.createBooking({tripId:t.id,seats:s}),o=null!==(l=e.bookingId)&&void 0!==l?l:null===(n=e.booking)||void 0===n?void 0:n.id;r.push("/payments/checkout?bookingId=".concat(encodeURIComponent(o)))}catch(e){alert((null==e?void 0:e.message)||"Booking failed")}finally{c(!1)}}}return(0,n.jsxs)("form",{onSubmit:d,className:"space-y-4",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"text-sm text-gray-600",children:"Seats"}),(0,n.jsxs)("div",{className:"flex items-center gap-3 mt-1",children:[(0,n.jsx)("button",{type:"button",onClick:()=>a(Math.max(1,s-1)),className:"px-3 py-1 border rounded",children:"-"}),(0,n.jsx)("div",{className:"w-10 text-center",children:s}),(0,n.jsx)("button",{type:"button",onClick:()=>{var e;return a(Math.min(null!==(e=t.seatsAvailable)&&void 0!==e?e:1,s+1))},className:"px-3 py-1 border rounded",children:"+"})]})]}),(0,n.jsx)("div",{children:(0,n.jsxs)("div",{className:"text-lg font-semibold",children:["KES ",(t.fareCents/100).toFixed(2)]})}),(0,n.jsx)("div",{children:(0,n.jsx)("button",{disabled:u,type:"submit",className:"px-4 py-2 bg-primary text-white rounded",children:u?"Booking...":"Book ".concat(s," seat").concat(s>1?"s":"")})})]})}},4162:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return w}});var n=r(6543),l=r(5729),i=r(6067),o=r(5695),s=r(3593),a=r(6429),u=r(1320),c=r(5167),d=r.n(c);r(5292);let h=d().icon({iconUrl:"/leaflet/marker-icon.png",shadowUrl:"/leaflet/marker-shadow.png",iconAnchor:[12,41]});function p(e){let{coords:t}=e,r=(0,i.Sx)();return(0,l.useEffect)(()=>{if(!r||!t||0===t.length)return;let e=d().latLngBounds(t);r.fitBounds(e.pad(.15))},[t,r]),null}function v(e){let{active:t,position:r}=e,n=(0,i.Sx)();return(0,l.useEffect)(()=>{n&&t&&r&&n.setView(r,n.getZoom(),{animate:!0})},[t,r,n]),null}function f(e){let{center:t=[0,0],zoom:r=13,markers:l=[],fitBounds:i=!1,children:c,height:d="100%",autoFollow:h=!1,followPosition:f=null}=e;return(0,n.jsx)("div",{style:{height:d,width:"100%"},children:(0,n.jsxs)(o.h,{center:t,zoom:r,scrollWheelZoom:!0,style:{height:"100%",width:"100%"},children:[(0,n.jsx)(s.I,{attribution:"\xa9 OpenStreetMap",url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),i&&l.length>0&&(0,n.jsx)(p,{coords:l.map(e=>[e.lat,e.lng])}),h&&f&&(0,n.jsx)(v,{active:h,position:f}),l.map((e,t)=>(0,n.jsx)(a.J,{position:[e.lat,e.lng],children:e.popup&&(0,n.jsx)(u.G,{children:e.popup})},t)),c]})})}function g(e){var t,r,i;let{position:o,driver:s,title:u}=e,c=(0,l.useRef)(null),h=d().divIcon({className:"driver-marker",html:'\n      <div style="display:flex;flex-direction:column;align-items:center">\n        <div style="width:40px;height:40px;border-radius:50%;overflow:hidden;border:2px solid white;box-shadow:0 1px 3px rgba(0,0,0,0.2)">\n          <img src="'.concat(null!==(t=null==s?void 0:s.avatarUrl)&&void 0!==t?t:"/icons/driver.png",'" style="width:40px;height:40px;object-fit:cover" />\n        </div>\n        <div style="background:rgba(0,0,0,0.6);color:white;padding:2px 6px;border-radius:6px;margin-top:6px;font-size:11px">\n          ').concat(null!==(i=null!==(r=null==s?void 0:s.name)&&void 0!==r?r:u)&&void 0!==i?i:"Driver","\n        </div>\n      </div>\n    "),iconSize:[40,58],iconAnchor:[20,58]});return(0,l.useEffect)(()=>{if(!c.current)return;let e=c.current,t=e.getLatLng(),r=d().latLng(o[0],o[1]),n=Math.max(6,Math.round(37.5)),l=0,i=(r.lat-t.lat)/n,s=(r.lng-t.lng)/n,a=()=>{l++;let r=d().latLng(t.lat+i*l,t.lng+s*l);e.setLatLng(r),l<n&&requestAnimationFrame(a)};requestAnimationFrame(a)},[o]),(0,n.jsx)(a.J,{ref:e=>{c.current=e},position:o,icon:h})}d().Marker.prototype.options.icon=h;var m=r(7023),x=r(148);r(2702);var b=r(2702);let y=null;function w(e){var t;let{tripId:r}=e,{driverLocation:i,trip:o}=function(e){let[t,r]=(0,l.useState)(!1),[n,i]=(0,l.useState)(null),[o,s]=(0,l.useState)(null),[a,u]=(0,l.useState)(null),c=(0,l.useRef)(null),d=(0,l.useRef)({}),h=(0,l.useRef)(null);function p(){h.current||(h.current=setTimeout(()=>{h.current=null,function(){let e=d.current;e.loc&&i(e.loc),e.trip&&s(t=>({...t||{},...e.trip})),void 0!==e.status&&u(e.status),d.current={}}()},200))}return(0,l.useEffect)(()=>{if(!e)return;let t=function(){if(y)return y;let e=b.env.NEXT_PUBLIC_API_WS||"http://localhost:3001";return y=(0,m.io)(e,{auth:{token:x.t.get("sisimove_token")}})}();c.current=t;let n=()=>{r(!0),t.emit("subscribe:trip",{tripId:e}),t.emit("get:trip",{tripId:e})},l=()=>{r(!1)},i=e=>{let t=function(e){var t,r,n,l,i,o,s,a,u;if(!e)return null;let c=Number(null!==(n=null!==(r=e.lat)&&void 0!==r?r:e.latitude)&&void 0!==n?n:e.lat_gps),d=Number(null!==(i=null!==(l=e.lng)&&void 0!==l?l:e.longitude)&&void 0!==i?i:e.lng_gps),h=null!==(s=null!==(o=e.ts)&&void 0!==o?o:e.time)&&void 0!==s?s:new Date().toISOString();return Number.isNaN(c)||Number.isNaN(d)?null:{lat:c,lng:d,ts:h,driverId:null!==(u=null!==(a=e.driverId)&&void 0!==a?a:e.driver_id)&&void 0!==u?u:null===(t=e.driver)||void 0===t?void 0:t.id}}(e);t&&(d.current.loc=t,p())},o=e=>{var t,r,n,l,i,o;let s=e?{id:null!==(r=null!==(t=e.id)&&void 0!==t?t:e.tripId)&&void 0!==r?r:e.trip_id,status:null!==(n=e.status)&&void 0!==n?n:e.state,driver:null!==(l=e.driver)&&void 0!==l?l:e.driver_info,route:null!==(o=null!==(i=e.route)&&void 0!==i?i:e.polyline)&&void 0!==o?o:e.path}:null;s&&(d.current.trip=s,p())},s=e=>{var t,r;let n=null!==(r=null!==(t=null==e?void 0:e.status)&&void 0!==t?t:e)&&void 0!==r?r:null;d.current.status=n,p()};return t.on("connect",n),t.on("disconnect",l),t.on("driver:location",i),t.on("trip:update",o),t.on("trip:status",s),()=>{try{t.emit("unsubscribe:trip",{tripId:e})}catch(e){}t.off("connect",n),t.off("disconnect",l),t.off("driver:location",i),t.off("trip:update",o),t.off("trip:status",s),h.current&&(clearTimeout(h.current),h.current=null),c.current=null}},[e]),{connected:t,driverLocation:n,trip:o,status:a,socket:c.current}}(r),s=i?[i.lat,i.lng]:(null==o?void 0:null===(t=o.origin)||void 0===t?void 0:t.lat)?[o.origin.lat,o.origin.lng]:[0,0];return(0,n.jsx)("div",{className:"h-96 rounded overflow-hidden shadow",children:(0,n.jsx)(f,{center:s,zoom:13,autoFollow:!0,followPosition:i?[i.lat,i.lng]:null,children:i&&(0,n.jsx)(g,{position:[i.lat,i.lng]})})})}},4580:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return o}});var n=r(6543);let l=(0,r(2651).Z)("star",[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]]);function i(e){let{rating:t=0}=e,r=Math.round(t);return(0,n.jsx)("div",{className:"flex items-center gap-0.5",children:[1,2,3,4,5].map(e=>(0,n.jsx)(l,{size:16,className:e<=r?"text-yellow-500 fill-yellow-500":"text-gray-300"},e))})}function o(e){var t,r,l,o;let{driver:s}=e;return s?(0,n.jsxs)("div",{className:"flex items-center gap-4 bg-white p-4 rounded-xl shadow-sm",children:[(0,n.jsx)("div",{className:"w-14 h-14 rounded-full overflow-hidden bg-gray-100 shadow-sm flex-shrink-0",children:(0,n.jsx)("img",{src:null!==(t=s.avatarUrl)&&void 0!==t?t:"/icons/driver.png",alt:s.name||"Driver",className:"w-full h-full object-cover"})}),(0,n.jsxs)("div",{className:"flex-1",children:[(0,n.jsx)("div",{className:"font-medium text-gray-800",children:null!==(r=s.name)&&void 0!==r?r:"Driver"}),s.vehicle&&(0,n.jsxs)("div",{className:"text-sm text-gray-500",children:[s.vehicle.brand," â€¢ ",s.vehicle.plate]}),(0,n.jsxs)("div",{className:"mt-1 flex items-center gap-2",children:[(0,n.jsx)(i,{rating:null!==(l=s.rating)&&void 0!==l?l:4.6}),(0,n.jsxs)("span",{className:"text-xs text-gray-500",children:["(",null!==(o=s.ratingCount)&&void 0!==o?o:18,")"]})]})]}),s.phone&&(0,n.jsx)("div",{className:"text-sm text-gray-600 text-right",children:s.phone})]}):null}},187:function(e,t,r){"use strict";r.d(t,{V:function(){return i}});let n="http://localhost:3001".replace(/\/$/,"")||"http://localhost:5000";async function l(e,t,r){let l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i=localStorage.getItem("token"),o={"Content-Type":"application/json",...l.headers||{}};i&&(o.Authorization="Bearer ".concat(i));let s=await fetch("".concat(n).concat(t),{method:e,headers:o,body:r?JSON.stringify(r):void 0}),a=null;try{a=await s.json()}catch(e){a=null}if(!s.ok){let e=Error((null==a?void 0:a.message)||(null==a?void 0:a.error)||s.statusText);throw e.data=a,e.status=s.status,e}return a}let i={get(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return l("GET",e,void 0,t)},post(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return l("POST",e,t,r)},put(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return l("PUT",e,t,r)},patch(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return l("PATCH",e,t,r)},delete(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return l("DELETE",e,void 0,t)},getMe(){return this.get("/auth/me")},createBooking(e){return this.post("/bookings/create",e)},getBooking(e){return this.get("/bookings/".concat(encodeURIComponent(e)))},applyPromo(e){return this.post("/promos/apply",e)},createCheckout(e){return this.post("/payments/checkout",e)},getTrip(e){return this.get("/trips/".concat(e))},saveSubscription(e){return this.post("/push/subscribe",{subscription:e})},getSubscriptions(){return this.get("/push/subscriptions")},deleteSubscription(e){return this.delete("/push/subscriptions/".concat(encodeURIComponent(e)))}}},148:function(e,t,r){"use strict";r.d(t,{t:function(){return n}});let n={set(e,t){try{"string"==typeof t?localStorage.setItem(e,t):localStorage.setItem(e,JSON.stringify(t))}catch(e){console.error("storage.set error:",e)}},get(e){try{let t=localStorage.getItem(e);if(!t)return null;if(t.startsWith("{")||t.startsWith("[")||"null"===t)return JSON.parse(t);return t}catch(e){return console.error("storage.get error:",e),null}},remove(e){try{localStorage.removeItem(e)}catch(e){console.error("storage.remove error:",e)}}}},2651:function(e,t,r){"use strict";r.d(t,{Z:function(){return d}});var n=r(5729);/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let l=e=>e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),i=e=>e.replace(/^([A-Z])|[\s-_]+(\w)/g,(e,t,r)=>r?r.toUpperCase():t.toLowerCase()),o=e=>{let t=i(e);return t.charAt(0).toUpperCase()+t.slice(1)},s=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.filter((e,t,r)=>!!e&&""!==e.trim()&&r.indexOf(e)===t).join(" ").trim()},a=e=>{for(let t in e)if(t.startsWith("aria-")||"role"===t||"title"===t)return!0};/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var u={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let c=(0,n.forwardRef)((e,t)=>{let{color:r="currentColor",size:l=24,strokeWidth:i=2,absoluteStrokeWidth:o,className:c="",children:d,iconNode:h,...p}=e;return(0,n.createElement)("svg",{ref:t,...u,width:l,height:l,stroke:r,strokeWidth:o?24*Number(i)/Number(l):i,className:s("lucide",c),...!d&&!a(p)&&{"aria-hidden":"true"},...p},[...h.map(e=>{let[t,r]=e;return(0,n.createElement)(t,r)}),...Array.isArray(d)?d:[d]])}),d=(e,t)=>{let r=(0,n.forwardRef)((r,i)=>{let{className:a,...u}=r;return(0,n.createElement)(c,{ref:i,iconNode:t,className:s("lucide-".concat(l(o(e))),"lucide-".concat(e),a),...u})});return r.displayName=o(e),r}},615:function(e,t,r){"use strict";var n=r(5411);r.o(n,"usePathname")&&r.d(t,{usePathname:function(){return n.usePathname}}),r.o(n,"useRouter")&&r.d(t,{useRouter:function(){return n.useRouter}})}},function(e){e.O(0,[371,585,682,744],function(){return e(e.s=9519)}),_N_E=e.O()}]);