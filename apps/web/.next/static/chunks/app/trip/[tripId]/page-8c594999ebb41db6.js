(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[659],{5167:function(){},5292:function(){},4e3:function(){},9519:function(t,e,r){Promise.resolve().then(r.bind(r,1637)),Promise.resolve().then(r.bind(r,4162)),Promise.resolve().then(r.bind(r,4580)),Promise.resolve().then(r.bind(r,1987))},1637:function(t,e,r){"use strict";r.r(e),r.d(e,{default:function(){return s}});var n=r(6543),i=r(5729),l=r(187),o=r(615);function s(t){let{serverTrip:e}=t,r=(0,o.useRouter)(),[s,a]=(0,i.useState)(1),[u,c]=(0,i.useState)(!1);async function d(t){if(null==t||t.preventDefault(),e){c(!0);try{let t=await l.V.createBooking({tripId:e.id,seats:s});r.push("/payments/checkout?bookingId=".concat(encodeURIComponent(t.id)))}catch(t){alert((null==t?void 0:t.message)||"Booking failed")}finally{c(!1)}}}return(0,n.jsxs)("form",{onSubmit:d,className:"space-y-4",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"text-sm text-gray-600",children:"Seats"}),(0,n.jsxs)("div",{className:"flex items-center gap-3 mt-1",children:[(0,n.jsx)("button",{type:"button",onClick:()=>a(Math.max(1,s-1)),className:"px-3 py-1 border rounded",children:"-"}),(0,n.jsx)("div",{className:"w-10 text-center",children:s}),(0,n.jsx)("button",{type:"button",onClick:()=>{var t;return a(Math.min(null!==(t=e.seatsAvailable)&&void 0!==t?t:1,s+1))},className:"px-3 py-1 border rounded",children:"+"})]})]}),(0,n.jsx)("div",{children:(0,n.jsxs)("div",{className:"text-lg font-semibold",children:["KES ",(e.fareCents/100).toFixed(2)]})}),(0,n.jsx)("div",{children:(0,n.jsx)("button",{disabled:u,type:"submit",className:"px-4 py-2 bg-primary text-white rounded",children:u?"Booking...":"Book ".concat(s," seat").concat(s>1?"s":"")})})]})}},4162:function(t,e,r){"use strict";r.r(e),r.d(e,{default:function(){return w}});var n=r(6543),i=r(5729),l=r(6067),o=r(5695),s=r(3593),a=r(6429),u=r(1320),c=r(5167),d=r.n(c);r(5292);let h=d().icon({iconUrl:"/leaflet/marker-icon.png",shadowUrl:"/leaflet/marker-shadow.png",iconAnchor:[12,41]});function p(t){let{coords:e}=t,r=(0,l.Sx)();return(0,i.useEffect)(()=>{if(!r||!e||0===e.length)return;let t=d().latLngBounds(e);r.fitBounds(t.pad(.15))},[e,r]),null}function g(t){let{active:e,position:r}=t,n=(0,l.Sx)();return(0,i.useEffect)(()=>{n&&e&&r&&n.setView(r,n.getZoom(),{animate:!0})},[e,r,n]),null}function v(t){let{center:e=[0,0],zoom:r=13,markers:i=[],fitBounds:l=!1,children:c,height:d="100%",autoFollow:h=!1,followPosition:v=null}=t;return(0,n.jsx)("div",{style:{height:d,width:"100%"},children:(0,n.jsxs)(o.h,{center:e,zoom:r,scrollWheelZoom:!0,style:{height:"100%",width:"100%"},children:[(0,n.jsx)(s.I,{attribution:"\xa9 OpenStreetMap",url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),l&&i.length>0&&(0,n.jsx)(p,{coords:i.map(t=>[t.lat,t.lng])}),h&&v&&(0,n.jsx)(g,{active:h,position:v}),i.map((t,e)=>(0,n.jsx)(a.J,{position:[t.lat,t.lng],children:t.popup&&(0,n.jsx)(u.G,{children:t.popup})},e)),c]})})}function f(t){var e,r,l;let{position:o,driver:s,title:u}=t,c=(0,i.useRef)(null),h=d().divIcon({className:"driver-marker",html:'\n      <div style="display:flex;flex-direction:column;align-items:center">\n        <div style="width:40px;height:40px;border-radius:50%;overflow:hidden;border:2px solid white;box-shadow:0 1px 3px rgba(0,0,0,0.2)">\n          <img src="'.concat(null!==(e=null==s?void 0:s.avatarUrl)&&void 0!==e?e:"/icons/driver.png",'" style="width:40px;height:40px;object-fit:cover" />\n        </div>\n        <div style="background:rgba(0,0,0,0.6);color:white;padding:2px 6px;border-radius:6px;margin-top:6px;font-size:11px">\n          ').concat(null!==(l=null!==(r=null==s?void 0:s.name)&&void 0!==r?r:u)&&void 0!==l?l:"Driver","\n        </div>\n      </div>\n    "),iconSize:[40,58],iconAnchor:[20,58]});return(0,i.useEffect)(()=>{if(!c.current)return;let t=c.current,e=t.getLatLng(),r=d().latLng(o[0],o[1]),n=Math.max(6,Math.round(37.5)),i=0,l=(r.lat-e.lat)/n,s=(r.lng-e.lng)/n,a=()=>{i++;let r=d().latLng(e.lat+l*i,e.lng+s*i);t.setLatLng(r),i<n&&requestAnimationFrame(a)};requestAnimationFrame(a)},[o]),(0,n.jsx)(a.J,{ref:t=>{c.current=t},position:o,icon:h})}d().Marker.prototype.options.icon=h;var m=r(7023),x=r(148);r(2702);var b=r(2702);let y=null;function w(t){var e;let{tripId:r}=t,{driverLocation:l,trip:o}=function(t){let[e,r]=(0,i.useState)(!1),[n,l]=(0,i.useState)(null),[o,s]=(0,i.useState)(null),[a,u]=(0,i.useState)(null),c=(0,i.useRef)(null),d=(0,i.useRef)({}),h=(0,i.useRef)(null);function p(){h.current||(h.current=setTimeout(()=>{h.current=null,function(){let t=d.current;t.loc&&l(t.loc),t.trip&&s(e=>({...e||{},...t.trip})),void 0!==t.status&&u(t.status),d.current={}}()},200))}return(0,i.useEffect)(()=>{if(!t)return;let e=function(){if(y)return y;let t=b.env.NEXT_PUBLIC_API_WS||"http://localhost:3001";return y=(0,m.io)(t,{auth:{token:x.t.get("sisimove_token")}})}();c.current=e;let n=()=>{r(!0),e.emit("subscribe:trip",{tripId:t}),e.emit("get:trip",{tripId:t})},i=()=>{r(!1)},l=t=>{let e=function(t){var e,r,n,i,l,o,s,a,u;if(!t)return null;let c=Number(null!==(n=null!==(r=t.lat)&&void 0!==r?r:t.latitude)&&void 0!==n?n:t.lat_gps),d=Number(null!==(l=null!==(i=t.lng)&&void 0!==i?i:t.longitude)&&void 0!==l?l:t.lng_gps),h=null!==(s=null!==(o=t.ts)&&void 0!==o?o:t.time)&&void 0!==s?s:new Date().toISOString();return Number.isNaN(c)||Number.isNaN(d)?null:{lat:c,lng:d,ts:h,driverId:null!==(u=null!==(a=t.driverId)&&void 0!==a?a:t.driver_id)&&void 0!==u?u:null===(e=t.driver)||void 0===e?void 0:e.id}}(t);e&&(d.current.loc=e,p())},o=t=>{var e,r,n,i,l,o;let s=t?{id:null!==(r=null!==(e=t.id)&&void 0!==e?e:t.tripId)&&void 0!==r?r:t.trip_id,status:null!==(n=t.status)&&void 0!==n?n:t.state,driver:null!==(i=t.driver)&&void 0!==i?i:t.driver_info,route:null!==(o=null!==(l=t.route)&&void 0!==l?l:t.polyline)&&void 0!==o?o:t.path}:null;s&&(d.current.trip=s,p())},s=t=>{var e,r;let n=null!==(r=null!==(e=null==t?void 0:t.status)&&void 0!==e?e:t)&&void 0!==r?r:null;d.current.status=n,p()};return e.on("connect",n),e.on("disconnect",i),e.on("driver:location",l),e.on("trip:update",o),e.on("trip:status",s),()=>{try{e.emit("unsubscribe:trip",{tripId:t})}catch(t){}e.off("connect",n),e.off("disconnect",i),e.off("driver:location",l),e.off("trip:update",o),e.off("trip:status",s),h.current&&(clearTimeout(h.current),h.current=null),c.current=null}},[t]),{connected:e,driverLocation:n,trip:o,status:a,socket:c.current}}(r),s=l?[l.lat,l.lng]:(null==o?void 0:null===(e=o.origin)||void 0===e?void 0:e.lat)?[o.origin.lat,o.origin.lng]:[0,0];return(0,n.jsx)("div",{className:"h-96 rounded overflow-hidden shadow",children:(0,n.jsx)(v,{center:s,zoom:13,autoFollow:!0,followPosition:l?[l.lat,l.lng]:null,children:l&&(0,n.jsx)(f,{position:[l.lat,l.lng]})})})}},4580:function(t,e,r){"use strict";r.r(e),r.d(e,{default:function(){return o}});var n=r(6543);let i=(0,r(2651).Z)("star",[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]]);function l(t){let{rating:e=0}=t,r=Math.round(e);return(0,n.jsx)("div",{className:"flex items-center gap-0.5",children:[1,2,3,4,5].map(t=>(0,n.jsx)(i,{size:16,className:t<=r?"text-yellow-500 fill-yellow-500":"text-gray-300"},t))})}function o(t){var e,r,i,o;let{driver:s}=t;return s?(0,n.jsxs)("div",{className:"flex items-center gap-4 bg-white p-4 rounded-xl shadow-sm",children:[(0,n.jsx)("div",{className:"w-14 h-14 rounded-full overflow-hidden bg-gray-100 shadow-sm flex-shrink-0",children:(0,n.jsx)("img",{src:null!==(e=s.avatarUrl)&&void 0!==e?e:"/icons/driver.png",alt:s.name||"Driver",className:"w-full h-full object-cover"})}),(0,n.jsxs)("div",{className:"flex-1",children:[(0,n.jsx)("div",{className:"font-medium text-gray-800",children:null!==(r=s.name)&&void 0!==r?r:"Driver"}),s.vehicle&&(0,n.jsxs)("div",{className:"text-sm text-gray-500",children:[s.vehicle.brand," â€¢ ",s.vehicle.plate]}),(0,n.jsxs)("div",{className:"mt-1 flex items-center gap-2",children:[(0,n.jsx)(l,{rating:null!==(i=s.rating)&&void 0!==i?i:4.6}),(0,n.jsxs)("span",{className:"text-xs text-gray-500",children:["(",null!==(o=s.ratingCount)&&void 0!==o?o:18,")"]})]})]}),s.phone&&(0,n.jsx)("div",{className:"text-sm text-gray-600 text-right",children:s.phone})]}):null}},187:function(t,e,r){"use strict";r.d(e,{V:function(){return o}});let n="http://localhost:3001".replace(/\/$/,"")||"http://localhost:3001",i="".concat(n,"/api");async function l(t,e){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n={"Content-Type":"application/json",...r.headers||{}};r.token&&(n.Authorization="Bearer ".concat(r.token));let l=i+e+function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=new URLSearchParams;for(let r in t)void 0!==t[r]&&null!==t[r]&&e.append(r,t[r].toString());let r=e.toString();return r?"?".concat(r):""}(r.params),o=await fetch(l,{method:t,headers:n,credentials:"include",body:r.body?JSON.stringify(r.body):void 0}),s=null;try{s=await o.json()}catch(t){}if(!o.ok){let t=Error((null==s?void 0:s.message)||"Request failed");throw t.status=o.status,t.data=s,t}return s}let o={request:l,get(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return l("GET",t,e)},post(t,e){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return l("POST",t,{...r,body:e})},put(t,e){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return l("PUT",t,{...r,body:e})},patch(t,e){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return l("PATCH",t,{...r,body:e})},del(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return l("DELETE",t,e)},login(t,e){return this.post("/auth/login",{email:t,password:e})},logout(){return this.post("/auth/logout")},getMe(){return this.get("/auth/me")},getDriverTrips(){return this.get("/drivers/trips")},getDriverBookings(){return this.get("/drivers/bookings")},getWallet(){return this.get("/drivers/wallet/me")},getMyBookings(){return this.get("/passengers/bookings/my")},createBooking(t){return this.post("/passengers/bookings",t)},cancelBooking(t,e){return this.post("/passengers/bookings/cancel",{bookingId:t,reason:e})},getTrips(t){return this.get("/trips",{params:t})},postTrip(t){return this.post("/trips",t)},getSubscriptions(){return this.get("/push/subscription")},saveSubscription(t){return this.post("/push/subscription",{subscription:t})},deleteSubscription(t){return this.del("/push/subscription/".concat(t))},createCheckout(t){return this.post("/passengers/payments/checkout",t)},getPayment(t){return this.get("/payments/".concat(t))},getPaymentsForBooking(t){return this.get("/passengers/bookings/".concat(t,"/payments"))}}},148:function(t,e,r){"use strict";r.d(e,{t:function(){return n}});let n={set(t,e){try{"string"==typeof e?localStorage.setItem(t,e):localStorage.setItem(t,JSON.stringify(e))}catch(t){console.error("storage.set error:",t)}},get(t){try{let e=localStorage.getItem(t);if(!e)return null;if(e.startsWith("{")||e.startsWith("[")||"null"===e)return JSON.parse(e);return e}catch(t){return console.error("storage.get error:",t),null}},remove(t){try{localStorage.removeItem(t)}catch(t){console.error("storage.remove error:",t)}}}},2651:function(t,e,r){"use strict";r.d(e,{Z:function(){return d}});var n=r(5729);/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let i=t=>t.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),l=t=>t.replace(/^([A-Z])|[\s-_]+(\w)/g,(t,e,r)=>r?r.toUpperCase():e.toLowerCase()),o=t=>{let e=l(t);return e.charAt(0).toUpperCase()+e.slice(1)},s=function(){for(var t=arguments.length,e=Array(t),r=0;r<t;r++)e[r]=arguments[r];return e.filter((t,e,r)=>!!t&&""!==t.trim()&&r.indexOf(t)===e).join(" ").trim()},a=t=>{for(let e in t)if(e.startsWith("aria-")||"role"===e||"title"===e)return!0};/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var u={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let c=(0,n.forwardRef)((t,e)=>{let{color:r="currentColor",size:i=24,strokeWidth:l=2,absoluteStrokeWidth:o,className:c="",children:d,iconNode:h,...p}=t;return(0,n.createElement)("svg",{ref:e,...u,width:i,height:i,stroke:r,strokeWidth:o?24*Number(l)/Number(i):l,className:s("lucide",c),...!d&&!a(p)&&{"aria-hidden":"true"},...p},[...h.map(t=>{let[e,r]=t;return(0,n.createElement)(e,r)}),...Array.isArray(d)?d:[d]])}),d=(t,e)=>{let r=(0,n.forwardRef)((r,l)=>{let{className:a,...u}=r;return(0,n.createElement)(c,{ref:l,iconNode:e,className:s("lucide-".concat(i(o(t))),"lucide-".concat(t),a),...u})});return r.displayName=o(t),r}},615:function(t,e,r){"use strict";var n=r(5411);r.o(n,"usePathname")&&r.d(e,{usePathname:function(){return n.usePathname}}),r.o(n,"useRouter")&&r.d(e,{useRouter:function(){return n.useRouter}})}},function(t){t.O(0,[371,585,682,744],function(){return t(t.s=9519)}),_N_E=t.O()}]);